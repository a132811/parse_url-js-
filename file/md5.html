<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>HTML5 read files hash</title>
<meta name="author" content="Mofei">
<script src="http://www.zhuwenlong.com/demo/html5Hash/spark-md5.js" type="text/javascript"></script>
</head>

<body>
<div>
	<header>
		<h1>HTML5 read files hash</h1>
	</header>
	<div>
		<input type="file" id="file">
		<div id="box"> </div>
	</div>
</div>
<script type="text/javascript">
function getMd5(fileNode, callback){
	var fileReader = new FileReader();// box = document.getElementById('box');
	var blobSlice = File.prototype.mozSlice || File.prototype.webkitSlice || File.prototype.slice, 
		//file = document.getElementById("file").files[0], 
		file = fileNode.files[0],
		chunkSize = 2097152,
		// read in chunks of 2MB
		chunks = Math.ceil(file.size / chunkSize), 
		currentChunk = 0, 
		spark = new SparkMD5();

	fileReader.onload = function(e) {
		spark.appendBinary(e.target.result);
		// append binary string
		currentChunk++;

		if (currentChunk < chunks) {
			loadNext();
		} else {
			var md5 = spark.end();
			console.info("computed hash", spark.end());//the later is not right
			fileNode.dataset.md5 = md5;
			if(callback){
				callback(md5);
			}
		}
	};

	function loadNext() {
		var start = currentChunk * chunkSize, end = start + chunkSize >= file.size ? file.size : start + chunkSize;
		fileReader.readAsBinaryString(blobSlice.call(file, start, end));
	}
	loadNext();
}

document.getElementById("file").addEventListener("change", function(e) {
												 getMd5(e.target);
												 });
</script>
</body>
</html>


<!DOCTYPE html>
<html>
<head>
    {literal}
    <title>Upload Demo</title>
    <script src="/js/spark-md5.js" type="text/javascript"></script>
    <script src="/js/jquery-2.1.1.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        function blobSlice(file, start, end) {
            var blobSlice = File.prototype.mozSlice || File.prototype.webkitSlice || File.prototype.slice;
            return blobSlice.call(file, start, end);
        }
        function getMd5(fileNode, callback) {
            var fileReader = new FileReader();
            var file = fileNode.files[0],
                    chunkSize = 2097152,
                    chunks = Math.ceil(file.size / chunkSize),
                    currentChunk = 0,
                    spark = new SparkMD5();

            fileReader.onload = function (e) {
                spark.appendBinary(e.target.result);
                currentChunk++;

                if (currentChunk < chunks) {
                    loadNext();
                } else {
                    var md5 = spark.end();
                    fileNode.dataset.md5 = md5;
                    if (callback) {
                        callback(md5);
                    }
                }
            };

            function loadNext() {
                var start = currentChunk * chunkSize, end = start + chunkSize >= file.size ? file.size : start + chunkSize;
                fileReader.readAsBinaryString(blobSlice(file, start, end));
            }

            loadNext();
        }

        function upload() {
            var fileNode = document.getElementById('file');
            var cancelNode = document.getElementById('cancel');
            getMd5(fileNode, function (md5) {
                uploadFile("/admin/tool/upload?act=uploadFile", fileNode, cancelNode, md5);
            });
        }
        function uploadFile(api, fileNode, cancelNode, md5) {
            var file = fileNode.files[0];
            const BYTES_PER_CHUNK = 2*1024*1024;//2M
            const SIZE = file.size;
            const path = $('#path').val();
            var xhr;
            uploadFileSlice(0, SIZE);

            function uploadFileSlice(start, size) {
                var fd = new FormData();
                var blobFile = blobSlice(file, start, start+BYTES_PER_CHUNK);
                if(typeof md5 === 'string' && md5){
                    fd.append("md5", md5);
                }
                if(path === 'tmp'){
                    fd.append("file", file);
                }else{
                    fd.append("file", blobFile);
                }
                fd.append("filename", file.name);
                fd.append("start", start);
                fd.append("size", size);
                fd.append("path", path);
                xhr = new XMLHttpRequest();
                xhr.addEventListener("load", function () {
                    var data = JSON.parse(xhr.responseText);
                    console.log(data);
                    if(data['errno'] === 0){
                        if(data.next_start && data.next_start > start && data.next_start < size){
                            uploadFileSlice(data.next_start, size);
                        }else{
                            $('#res').text(
                                    data.file_url
                            );
                        }
                        var val = data.next_start ? Math.floor(100 * data.next_start/size) : 100;
                        $('#progress').val(val);
                    } else{
                        $('#tip').text(data.error);
                    }
                }, false);
                xhr.upload.addEventListener("progress", uploadProgress, false);
                xhr.addEventListener("error", function () {
                }, false);
                xhr.open("POST", api);
                xhr.setRequestHeader("Accept", "application/json");
                xhr.send(fd);
            }

            function uploadProgress(e) {
                if (e.lengthComputable) {
                    var percentComplete = Math.round(e.loaded * 100 / e.total);
                }
            }

            if (cancelNode) {
                cancelNode.addEventListener('click', function (e) {
                    xhr.abort();
                    xhr = null;
                });
            }
        }


    </script>
</head>
<body>
<div style="width: 80% ;height:80%;margin:10%;">
    <label for="file">Select a File to Upload</label><br/>
    <div id="tip" style="color:red;"></div>
    <input type="file" name="file" id="file" onchange="upload(this);"/>
    <input type="button" name="" id="cancel" value="stop upload"/><br>
    <input type="input" name="path" id="path" width="500" placeholder="上传目录, 比如: tmp" /><br>
    <pre id="res"></pre>
    <progress id="progress" max="100" value="0"></progress>
</div>

{/literal}
</body>
</html>
